$(function(){function e(){$.ajax({url:G+i+"/-1",type:"GET",dataType:"json",success:function(e){for(var t="",o=e.length,a=0;a<o;a++)t+='<li class="dir-item" data-tooltip="目录：'+e[a].subprojectname+'"><a href="javascript:void(0);" class="btn btn-dir" data-type="dir" data-parent="'+e[a].subprojectid+'"><span class="triangle left"></span>'+e[a].subprojectname+"</a></li>";$.ajax({url:O+"-1/"+i,type:"GET",dataType:"json",success:function(e){for(var o=e.length,a=0;a<o;a++)t+='<li class="page-item" data-tooltip="page：'+e[a].pagetitle+'"><a href="javascript:void(0);" class="btn btn-page" data-type="page" data-page="'+e[a].pageid+'" data-parent="-1">'+e[a].pagetitle+"</a></li>";u.html(t),$pages=u.find(".page-item").find(".btn-page");for(var a=0,i=$pages.length;a<i;a++)$pages.eq(a).data("page")==E&&$pages.eq(a).addClass("active")},error:function(e){console.log(e)}})},error:function(e){console.log(e)}})}function t(){x=$(document).height(),S=k>x?k:x,P.css("height",S).fadeIn(200),P.load("./tpls/share-page.html",function(e,t,o){var a=P.find(".page-share-container"),i=a.find(".link-address").find(".link"),n=a.height(),r=(k-n)/2;r=r>0?r:20,i.text(N),a.css("top",-n).animate({opacity:"1",top:r},200,function(){a.animate({top:r-30},200,function(){a.animate({top:r},200)})})})}function o(e){$.ajax({url:e,type:"GET",dataType:"json",success:function(e){b.text(e.page.pagetitle),""===n?n=editormd("test-editormd",{width:0,height:0,path:"../lib/",onload:function(){editormd.markdownToHTML("markdown-content",{markdown:e.page.pagecontext})}}):(y.html(""),editormd.markdownToHTML("markdown-content",{markdown:e.page.pagecontext})),w.fadeIn(function(){setTimeout(100,function(){console.log("page"),w.attr({"data-page":e.page.pageid,"data-project":e.page.pageprojectid,"data-parent":e.page.pagesubprejectid}).slideDown(500,function(){})},200)})},error:function(e){console.log(e)}})}function a(e){$.ajax({url:e,type:"GET",dataType:"json",success:function(e){for(var t=P.find(".edit-dir-container"),o=t.find(".exited-dir").find(".dir-list"),a=t.find(".edit-dir-form").find(".form-item").find("#_dirparname"),i="",n="",r=t.height(),c=0,s=e.length;c<s;c++)i+='<option value="'+e[c].subProjectName+'" data-level="'+e[c].nextLevel+'" data-parent="'+e[c].subProjectId+'">'+e[c].subProjectName+"</option>","无"!==e[c].subProjectName&&(n+='<li class="dir-item"><a href="javascript:void(0);" class="item-name btn" data-event="editdir" data-parent="'+e[c].subProjectId+'">'+e[c].subProjectName+"</a></li>");a.html(i),o.html(n),r=t.height()+(k-r>0?k-r:20),S=S>r?S:r,P.css("height",S)},error:function(e){console.log(e)}})}var i,n="",r=$("body"),c=r.find("#header"),s=c.find(".common-middle").find(".middle-title"),d=c.find(".common-right").eq(0),l=d.find(".btn-manage"),p=c.find(".feature-list"),m=r.find("#main"),f=m.find(".sideNav"),u=f.find("#project-nav").find("#project-list"),h=f.find(".add-item-operations").find(".btn-add-page"),g=f.find(".add-item-operations").find(".btn-add-dir"),v=f.find("#project-nav"),w=(v.find(".btn-dir"),v.find(".btn-page"),m.find(".show-content")),j=w.find(".content-operations"),b=(j.find(".btn-share"),j.find(".btn-copy"),j.find(".btn-edit"),j.find(".btn-remove"),w.find(".content-title").find(".title")),y=w.find("#markdown-content"),P=r.find("#mask"),T=!1,k=$(window).height(),x=$(document).height(),S=k>x?k:x,D=!1,N=window.location,I=decodeURI(N.search),C="",_="",E="",G=window.location.protocol+"//"+window.location.host+"/ShowDoc/subProject/querySubProject/",O=window.location.protocol+"//"+window.location.host+"/ShowDoc/page/selectPageByPid/",q=[],A=!1,L=!1,B="",H=!1;isdeletingdir=!1;for(var M=I.replace(/\?\s*/g,"").split("&"),U=0,R=M.length;U<R;U++){var z=M[U].split("=");"id"===z[0]&&(i=z[1]||""),"projectname"===z[0]&&(C=z[1]||""),"check"===z[0]&&(_=z[1]||""),"pageid"===z[0]&&(E=z[1]||"")}s.text(C),e(),""!=E&&(B=E,o(window.location.protocol+"//"+window.location.host+"/ShowDoc/page/selectPageById/"+E+"/"+i)),h.on("click",function(e){var t=window.location.protocol+"//"+window.location.host+"/ShowDoc/jsp/project/editproject.jsp?projectid="+i+"&projectname="+C+"&check="+_+"&type=new";window.location.href=t,e.preventDefault(),e.stopPropagation()}),g.on("click",function(){x=$(document).height(),S=k>x?k:x,P.css("height",S).fadeIn(200),P.load("tpls/create-dir.html",function(e,t,o){var a=P.find(".create-dir-container"),n=a.height(),r=(k-n)/2;r=r>0?r:20,a.css("top",-n).animate({top:r,opacity:1},200,function(){var e=window.location.protocol+"//"+window.location.host+"/ShowDoc/subProject/getAllProject/"+i;$.ajax({url:e,type:"GET",dataType:"json",success:function(e){for(var t=a.find(".form-item").find("#_dirparname"),o=a.find(".exited-dir").find(".dir-list"),i="",r="",c=0,s=e.length;c<s;c++)i+='<option value="'+e[c].subProjectName+'" data-level="'+e[c].nextLevel+'" data-parent="'+e[c].subProjectId+'">'+e[c].subProjectName+"</option>","无"!==e[c].subProjectName&&(r+='<li class="dir-item"><a href="javascript:void(0);" class="item-name btn" data-event="editdir" data-parent="'+e[c].subProjectId+'">'+e[c].subProjectName+"</a></li>");t.html(i),o.html(r),n=a.height()+(k-n>0?k-n:20),S=S>n?S:n,P.css("height",S)},error:function(e){console.log(e)}})})})}),P.on("click",function(t){var o=$(t.target),n=o.data("event");switch(n){case"close":P.fadeOut(200),P.html("");break;case"createdir":if(!D){D=!0;var r=o.parents(".create-dir-container"),c=r.find(".create-dir-form"),s=c.find(".form-item"),d=s.find("#_dirname"),l=s.find("#_dirnum"),p=s.find("#_dirparname"),m=d.val(),f=parseInt(l.val()),h=p.find("option:selected"),g=h.val(),v=h.data("parent"),j=h.data("level"),b=window.location.protocol+"//"+window.location.host+"/ShowDoc/subProject/addSubProject",y={};y={projectid:i,subprojectname:m,sublevel:j,parentid:v,parentName:g},isNaN(f)||(y.subsortid=f),""!==_&&(y.subprojectpassword=_),d.val(""),l.val(""),p.val(""),$.ajax({url:b,type:"POST",dataType:"json",data:y,success:function(t){D=!1;var o=t.result;if(o){var a=window.location.protocol+"//"+window.location.host+"/ShowDoc/subProject/getAllProject/"+i;$.ajax({url:a,type:"GET",dataType:"json",success:function(e){for(var t=r.find(".form-item").find("#_dirparname"),o=r.find(".exited-dir").find(".dir-list"),a="",i="",n=r.height(),c=0,s=e.length;c<s;c++)a+='<option value="'+e[c].subProjectName+'" data-level="'+e[c].nextLevel+'" data-parent="'+e[c].subProjectId+'">'+e[c].subProjectName+"</option>","无"!==e[c].subProjectName&&(i+='<li class="dir-item"><a href="javascript:void(0);" class="item-name btn" data-event="editdir" data-parent="'+e[c].subProjectId+'">'+e[c].subProjectName+"</a></li>");t.html(a),o.html(i),n=r.height()+(k-n>0?(k-n)/2:20),S=S>n?S:n,P.css("height",S)},error:function(e){console.log(e)}}),layer.msg("已成功创建目录",{time:1e3},function(){q.push(v),v===-1&&e()})}else layer.msg(t.message,{time:1500})},error:function(e){console.log(e)}})}break;case"removepage":var T=(w.data("page"),w.data("project"),w.data("parent")),x=window.location.protocol+"//"+window.location.host+"/ShowDoc/page/deletePageById/"+B+"/"+i;$.ajax({url:x,type:"POST",dataType:"json",success:function(t){P.trigger("click"),w.fadeOut(1),t.result&&(T===-1?e():(q.push(v),u.find(".active").remove())),layer.msg(t.message,{time:1e3})},error:function(e){console.log(e)}});break;case"removecancel":P.trigger("click");break;case"sharecancel":P.trigger("click");break;case"memberadd":if(!A){A=!0;var N=P.find(".member-manage-container"),I=N.find(".create-member-form"),C=I.find("#_username"),E=C.val(),G=window.location.protocol+"//"+window.location.host+"/ShowDoc/project/addProjectAuthor/"+i;$.ajax({url:G,type:"POST",data:{vname:E},success:function(e){var t=e.trim();if(C.val(""),"success"===t){var o=window.location.protocol+"//"+window.location.host+"/ShowDoc/project/queryProjectAuthor/"+i;$.ajax({url:o,type:"GET",dataType:"json",success:function(e){for(var t="",o=e.length,a=0;a<o;a++)t+='<li class="member-item"><a href="javascript:void(0);" class="btn btn-member" data-event="removemember" data-user="'+e[a].pid+'">'+e[a].vname+"</a></li>";P.find(".member-manage-container").find(".member-list").eq(0).html(t)},error:function(e){console.log(e)}}),layer.msg("已成功添加项目协作者并保存",{time:1e3},function(){A=!1})}else"fail"===t?layer.msg("对不起！添加失败啦<br/>可能的原因：项目不存在或您没有添加协作者的权限",{time:1500},function(){A=!1}):"illegal"===t?layer.msg("请输入协作者的用户名",{time:1500},function(){A=!1}):layer.msg("该用户名不存在或者已经添加过该用户啦",{tiemout:1500},function(){A=!1})},error:function(e){console.log(e)}})}break;case"memberback":P.trigger("click");break;case"removemember":if(!L){L=!0;var O=o.text(),M=o.data("user"),U=window.location.protocol+"//"+window.location.host+"/ShowDoc/project/deleteProjectAuthor/"+M;$.ajax({url:U,type:"POST",data:{vname:O},success:function(e){var t=e.trim();if("success"===t){var o=window.location.protocol+"//"+window.location.host+"/ShowDoc/project/queryProjectAuthor/"+i;$.ajax({url:o,type:"GET",dataType:"json",success:function(e){for(var t="",o=e.length,a=0;a<o;a++)t+='<li class="member-item"><a href="javascript:void(0);" class="btn btn-member" data-event="removemember" data-user="'+e[a].pid+'">'+e[a].vname+"</a></li>";P.find(".member-manage-container").find(".member-list").eq(0).html(t)},error:function(e){console.log(e)}}),layer.msg("已成功删除项目协作者",{time:1e3},function(){L=!1})}else"fail"===t?layer.msg("对不起！删除失败啦<br/>可能的原因：项目不存在或您没有删除协作者的权限",{time:2e3},function(){L=!1}):layer.msg("该用户名不存在或者已经删除过该用户啦",{tiemout:1500},function(){L=!1})},error:function(e){console.log(e)}})}break;case"editdir":var R=P.find(".create-dir-container"),z=o.data("parent"),F=0;R.length<1&&(R=P.find(".edit-dir-container")),F=R.position().top,R.fadeOut(function(){P.load("./tpls/edit-dir.html",function(e,t,o){var a=P.find(".edit-dir-container"),n=window.location.protocol+"//"+window.location.host+"/ShowDoc/subProject/querySubProjectByID/"+i+"/"+z,r=window.location.protocol+"//"+window.location.host+"/ShowDoc/subProject/getAllProject/"+i,c=a.find(".edit-dir-form"),s=c.find(".form-item").find("#_dirname"),d=c.find(".form-item").find("#_dirnum"),l=c.find(".form-item").find("#_dirparname");a.attr("data-dirid",z),a.css({opacity:"0",top:F}),$.ajax({url:n,type:"GET",dataType:"json",success:function(e){s.val(e.subprojectname),d.val(e.subsortid);var t=e;a.attr("data-dirparent",t.parentid),a.css("top",F),$.ajax({url:r,type:"GET",dataType:"json",success:function(e){for(var o=a.find(".exited-dir").find(".dir-list"),i="",n="",r=a.height(),c=0,s=e.length;c<s;c++)t.parentid===e[c].subProjectId?i+='<option value="'+e[c].subProjectName+'" data-level="'+e[c].nextLevel+'" data-parent="'+e[c].subProjectId+'" selected="selected">'+e[c].subProjectName+"</option>":e[c].subProjectId!==z&&(i+='<option value="'+e[c].subProjectName+'" data-level="'+e[c].nextLevel+'" data-parent="'+e[c].subProjectId+'">'+e[c].subProjectName+"</option>"),"无"!==e[c].subProjectName&&(n+='<li class="dir-item"><a href="javascript:void(0);" class="item-name btn" data-event="editdir" data-parent="'+e[c].subProjectId+'">'+e[c].subProjectName+"</a></li>");l.html(i),o.html(n),a.animate({opacity:"1"},300,function(){r=a.height()+(k-r>0?(k-r)/2:20),S=S>r?S:r,P.css("height",S)})},error:function(e){console.log(e)}})},error:function(e){console.log(e)}})})});break;case"updatedir":if(!H){H=!0;var J=P.find(".edit-dir-container"),K=J.find(".edit-dir-form"),d=K.find(".form-item").find("#_dirname"),l=K.find(".form-item").find("#_dirnum"),p=K.find(".form-item").find("#_dirparname"),Q=p.find("option:selected"),V=d.val(),W=parseInt(l.val()),X=Q.val(),Y=Q.data("parent"),Z=Q.data("level"),ee=J.data("dirid"),te=J.data("dirparent"),oe=window.location.protocol+"//"+window.location.host+"/ShowDoc/subProject/updateSubProject",y={},ae=window.location.protocol+"//"+window.location.host+"/ShowDoc/subProject/getAllProject/"+i;y={subprojectid:ee,projectid:i,subprojectname:V,sublevel:Z,parentid:Y,parentName:X},isNaN(W)||(y.subsortid=W),d.val(""),l.val(""),$.ajax({url:oe,type:"POST",data:y,dataType:"json",success:function(t){t.result?(a(ae),layer.msg("目录信息已更新并保存",{tiemout:1500},function(){H=!1,Y===-1||te===-1?e():Y!==-1&&te!==-1?(q.push(Y),q.push(te)):Y===-1&&te!==-1?(e(),q.push(te)):Y!==-1&&te===-1&&(e(),q.push(Y))})):layer.msg(t.message,{time:1500},function(){H=!1})},error:function(e){console.log(e)}})}break;case"deletedir":if(!isdeletingdir){isdeletingdir=!0;var J=P.find(".edit-dir-container"),z=J.data("dirid"),ie=J.data("dirparent"),K=J.find(".edit-dir-form"),d=K.find(".form-item").find("#_dirname"),l=K.find(".form-item").find("#_dirnum"),Q=K.find(".form-item").find("#_dirparname"),ne=window.location.protocol+"//"+window.location.host+"/ShowDoc/subProject/deleteSubProject/"+i+"/"+z+"/"+ie;$.ajax({url:ne,type:"POST",dataType:"json",success:function(t){if(t.result){d.val(""),l.val("");var o=window.location.protocol+"//"+window.location.host+"/ShowDoc/subProject/getAllProject/"+i;a(o),layer.msg("删除成功",{time:1500},function(){isdeletingdir=!1,ie===-1?e():ie!==-1&&q.push(ie)})}else layer.msg(t.message,{time:1500},function(){isdeletingdir=!1})},error:function(e){console.log(e)}})}}t.preventDefault(),t.stopPropagation()}),u.on("click",function(e){var t=$(e.target),a=t.data("type"),n=t.find(".triangle").eq(0);switch(a){case"dir":var r=t.data("parent"),c=t.siblings(".project-list");if(c.length>0&&c.is(":visible")||n.hasClass("top"))return c.slideUp(300),void n.toggleClass("left").css("transition","all 0.3s linear").toggleClass("top").css("transition","");if(c.length>0&&q.indexOf(r)===-1)c.hide().slideDown(300),n.toggleClass("left").css("transition","all 0.3s linear").toggleClass("top").css("transition","");else{var s=q.indexOf(r);s!==-1&&q.splice(s,1),c.remove(),$.ajax({url:G+i+"/"+r,type:"GET",dataType:"json",success:function(e){var o=e.length,a=$("<ul>"),c="";if(a.addClass("project-list"),o>0)for(var s=0;s<o;s++)c+='<li class="dir-item" data-tooltip="目录：'+e[s].subprojectname+'"><a href="javascript:void(0);" class="btn btn-dir" data-type="dir" data-parent="'+e[s].subprojectid+'"><span class="triangle left"></span>'+e[s].subprojectname+"</a></li>";$.ajax({url:O+r+"/"+i,type:"GET",dataType:"json",success:function(e){for(var o=e.length,i=0;i<o;i++)c+='<li class="page-item" data-tooltip="page：'+e[i].pagetitle+'"><a href="javascript:void(0);" class="btn btn-page" data-type="page" data-page="'+e[i].pageid+'" data-parent="'+r+'">'+e[i].pagetitle+"</a></li>";a.html(c).hide(),t.after(a),a.slideDown(300),n.toggleClass("left").css("transition","all 0.3s linear").toggleClass("top").css("transition","")},error:function(e){console.log(e)}})},error:function(e){console.log(e)}})}break;case"page":var d=t.data("page"),l=(t.data("parent"),window.location.protocol+"//"+window.location.host+"/ShowDoc/page/selectPageById/"+d+"/"+i);B=d,t.hasClass("active")||($(this).find(".btn-page").removeClass("active"),t.removeClass("hover").addClass("active"),o(l))}e.preventDefault(),e.stopPropagation()}),u.on("mouseover",function(e){var t=$(e.target),o=t.data("type");"page"!==o||t.hasClass("hover")||t.hasClass("active")||t.addClass("hover"),t.parent().addClass("hover")}).on("mouseout",function(e){var t=$(e.target),o=t.data("type");"page"===o&&t.hasClass("hover")&&t.removeClass("hover"),t.parent().removeClass("hover")}),m.on("click",function(e){var o=$(e.target),a=o.data("role");switch(a){case"share":t();break;case"copy":var n=window.location.protocol+"//"+window.location.host+"/ShowDoc/jsp/project/editproject.jsp?projectid="+i+"&projectname="+C+"&check="+_+"&pageid="+B+"&type=copy";window.location.href=n;break;case"edit":var n=window.location.protocol+"//"+window.location.host+"/ShowDoc/jsp/project/editproject.jsp?projectid="+i+"&projectname="+C+"&check="+_+"&pageid="+B+"&type=edit";window.location.href=n;break;case"remove":x=$(document).height(),S=k>x?k:x,P.css("height",S).fadeIn(200),P.load("./tpls/remove-page.html",function(e,t,o){var a=P.find(".remove-page-container"),i=a.height(),n=(k-i)/2;n=n>0?n:20,a.css("top",-i).animate({opacity:"1",top:n},200,function(){a.animate({top:n-30},200,function(){a.animate({top:n},200)})})})}e.preventDefault(),e.stopPropagation()}),d.hover(function(e){T||(l.addClass("hover"),p.fadeIn(100).css("top","25px").animate({top:"35px"},300,function(){T=!1})),e.preventDefault(),e.stopPropagation()},function(e){l.removeClass("hover"),p.fadeOut(200),e.preventDefault(),e.stopPropagation()}),d.on("click",function(e){var o=$(e.target),a=o.data("item");switch(a){case"share":t();break;case"member":x=$(document).height(),S=k>x?k:x,P.css("height",S).fadeIn(200),P.load("./tpls/member-manage.html",function(e,t,o){var a=P.find(".member-manage-container"),n=a.find(".member-list").eq(0),r=a.height(),c=(k-r)/2,s=window.location.protocol+"//"+window.location.host+"/ShowDoc/project/queryProjectAuthor/"+i;c=c>0?c:20,$.ajax({url:s,type:"GET",dataType:"json",success:function(e){for(var t="",o=e.length,i=0;i<o;i++)t+='<li class="member-item"><a href="javascript:void(0);" class="btn btn-member" data-event="removemember" data-user="'+e[i].pid+'">'+e[i].vname+"</a></li>";n.html(t),r=a.height(),c=(k-r)/2,c=c>0?c:20,a.css("top",-r).animate({opacity:"1",top:c},200,function(){a.animate({top:c-30},200,function(){a.animate({top:c},200)})})},error:function(e){console.log(e)}})});break;case"delete":var n=window.location.protocol+"//"+window.location.host+"/ShowDoc/project/deleteProject/"+i;$.ajax({url:n,type:"POST",dataType:"json",success:function(e){e.result?layer.msg("已成功删除项目",{time:1e3},function(){window.location.href=window.location.protocol+"//"+window.location.host+"/ShowDoc/project/showProject.action"}):layer.msg(e.message,{time:1500},function(){})},error:function(e){console.log(e)}});break;case"project":window.location.href=window.location.protocol+"//"+window.location.host+"/ShowDoc/project/showProject.action"}e.preventDefault(),e.stopPropagation()})});