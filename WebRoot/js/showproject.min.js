$(function(){function e(){$.ajax({url:_+n+"/-1",type:"GET",dataType:"json",success:function(e){for(var t="",o=e.length,a=0;a<o;a++)t+='<li class="dir-item" data-tooltip="目录：'+e[a].subprojectname+'"><a href="javascript:void(0);" class="btn btn-dir" data-type="dir" data-parent="'+e[a].subprojectid+'"><span class="triangle left"></span>'+e[a].subprojectname+"</a></li>";$.ajax({url:q+"-1/"+n,type:"GET",dataType:"json",success:function(e){for(var o=e.length,a=0;a<o;a++)t+='<li class="page-item" data-tooltip="page：'+e[a].pagetitle+'"><a href="javascript:void(0);" class="btn btn-page" data-type="page" data-page="'+e[a].pageid+'" data-parent="-1">'+e[a].pagetitle+"</a></li>";f.html(t),$pages=f.find(".page-item").find(".btn-page");for(var a=0,n=$pages.length;a<n;a++)$pages.eq(a).data("page")==G&&$pages.eq(a).addClass("active")},error:function(e){console.log(e)}})},error:function(e){console.log(e)}})}function t(){x=$(document).height(),D=T>x?T:x,P.css("height",D).fadeIn(200),P.load("./tpls/share-page.html",function(e,t,o){var a=P.find(".page-share-container"),n=a.find(".link-address").find(".link"),i=a.height(),r=(T-i)/2;r=r>0?r:20,n.text(N),a.css("top",-i).animate({opacity:"1",top:r},200,function(){a.animate({top:r-30},200,function(){a.animate({top:r},200)})})})}function o(e){$.ajax({url:e,type:"GET",dataType:"json",success:function(e){b.text(e.page.pagetitle),""===i?i=editormd("test-editormd",{width:0,height:0,path:"../lib/",onload:function(){editormd.markdownToHTML("markdown-content",{markdown:e.page.pagecontext})}}):(y.html(""),editormd.markdownToHTML("markdown-content",{markdown:e.page.pagecontext})),j.fadeIn(function(){setTimeout(100,function(){j.attr({"data-page":e.page.pageid,"data-project":e.page.pageprojectid,"data-parent":e.page.pagesubprejectid}).slideDown(500,function(){})},200)})},error:function(e){console.log(e)}})}function a(e){$.ajax({url:e,type:"GET",dataType:"json",success:function(e){for(var t=P.find(".edit-dir-container"),o=t.find(".exited-dir").find(".dir-list"),a=t.find(".edit-dir-form").find(".form-item").find("#_dirparname"),n="",i="",r=t.height(),c=0,s=e.length;c<s;c++)n+='<option value="'+e[c].subProjectName+'" data-level="'+e[c].nextLevel+'" data-parent="'+e[c].subProjectId+'">'+e[c].subProjectName+"</option>","无"!==e[c].subProjectName&&(i+='<li class="dir-item"><a href="javascript:void(0);" class="item-name btn" data-event="editdir" data-parent="'+e[c].subProjectId+'">'+e[c].subProjectName+"</a></li>");a.html(n),o.html(i),r=t.height()+(T-r>0?T-r:20),D=D>r?D:r,P.css("height",D)},error:function(e){console.log(e)}})}for(var n,i="",r=$("body"),c=r.find("#header"),s=c.find(".common-middle").find(".middle-title"),d=c.find(".common-right").eq(0),l=d.find(".btn-manage"),p=c.find(".feature-list"),m=r.find("#main"),u=m.find(".sideNav"),f=u.find("#project-nav").find("#project-list"),h=u.find(".add-item-operations").find(".btn-add-page"),g=u.find(".add-item-operations").find(".btn-add-dir"),v=u.find("#project-nav"),j=(v.find(".btn-dir"),v.find(".btn-page"),m.find(".show-content")),w=j.find(".content-operations"),b=(w.find(".btn-share"),w.find(".btn-copy"),w.find(".btn-edit"),w.find(".btn-remove"),j.find(".content-title").find(".title")),y=j.find("#markdown-content"),P=r.find("#mask"),k=!1,T=$(window).height(),x=$(document).height(),D=T>x?T:x,S=!1,N=window.location,I=decodeURI(N.search),C="",E="",G="",_=window.location.protocol+"//"+window.location.host+"/ShowDoc/subProject/querySubProject/",q=window.location.protocol+"//"+window.location.host+"/ShowDoc/page/selectPageByPid/",O=[],A=!1,L=!1,B="",H=!1,M=I.replace(/\?\s*/g,"").split("&"),U=0,R=M.length;U<R;U++){var z=M[U].split("=");"id"===z[0]&&(n=z[1]||""),"projectname"===z[0]&&(C=z[1]||""),"check"===z[0]&&(E=z[1]||""),"pageid"===z[0]&&(G=z[1]||"")}s.text(C),e(),""!=G&&(B=G,o(window.location.protocol+"//"+window.location.host+"/ShowDoc/page/selectPageById/"+G+"/"+n)),h.on("click",function(e){var t=window.location.protocol+"//"+window.location.host+"/ShowDoc/jsp/project/editproject.jsp?projectid="+n+"&projectname="+C+"&check="+E+"&type=new";window.location.href=t,e.preventDefault(),e.stopPropagation()}),g.on("click",function(){x=$(document).height(),D=T>x?T:x,P.css("height",D).fadeIn(200),P.load("tpls/create-dir.html",function(e,t,o){var a=P.find(".create-dir-container"),i=a.height(),r=(T-i)/2;r=r>0?r:20,a.css("top",-i).animate({top:r,opacity:1},200,function(){var e=window.location.protocol+"//"+window.location.host+"/ShowDoc/subProject/getAllProject/"+n;$.ajax({url:e,type:"GET",dataType:"json",success:function(e){for(var t=a.find(".form-item").find("#_dirparname"),o=a.find(".exited-dir").find(".dir-list"),n="",r="",c=0,s=e.length;c<s;c++)n+='<option value="'+e[c].subProjectName+'" data-level="'+e[c].nextLevel+'" data-parent="'+e[c].subProjectId+'">'+e[c].subProjectName+"</option>","无"!==e[c].subProjectName&&(r+='<li class="dir-item"><a href="javascript:void(0);" class="item-name btn" data-event="editdir" data-parent="'+e[c].subProjectId+'">'+e[c].subProjectName+"</a></li>");t.html(n),o.html(r),i=a.height()+(T-i>0?T-i:20),D=D>i?D:i,P.css("height",D)},error:function(e){console.log(e)}})})})}),P.on("click",function(t){var o=$(t.target),i=o.data("event");switch(i){case"close":P.fadeOut(200),P.html("");break;case"createdir":if(!S){S=!0;var r=o.parents(".create-dir-container"),c=r.find(".create-dir-form"),s=c.find(".form-item"),d=s.find("#_dirname"),l=s.find("#_dirnum"),p=s.find("#_dirparname"),m=d.val(),u=parseInt(l.val()),h=p.find("option:selected"),g=h.val(),v=h.data("parent"),w=h.data("level"),b=window.location.protocol+"//"+window.location.host+"/ShowDoc/subProject/addSubProject",y={};y={projectid:n,subprojectname:m,sublevel:w,parentid:v,parentName:g},isNaN(u)||(y.subsortid=u),""!==E&&(y.subprojectpassword=E),d.val(""),l.val(""),p.val(""),$.ajax({url:b,type:"POST",dataType:"json",data:y,success:function(t){S=!1;var o=t.result;if(o){var a=window.location.protocol+"//"+window.location.host+"/ShowDoc/subProject/getAllProject/"+n;$.ajax({url:a,type:"GET",dataType:"json",success:function(e){for(var t=r.find(".form-item").find("#_dirparname"),o=r.find(".exited-dir").find(".dir-list"),a="",n="",i=r.height(),c=0,s=e.length;c<s;c++)a+='<option value="'+e[c].subProjectName+'" data-level="'+e[c].nextLevel+'" data-parent="'+e[c].subProjectId+'">'+e[c].subProjectName+"</option>","无"!==e[c].subProjectName&&(n+='<li class="dir-item"><a href="javascript:void(0);" class="item-name btn" data-event="editdir" data-parent="'+e[c].subProjectId+'">'+e[c].subProjectName+"</a></li>");t.html(a),o.html(n),i=r.height()+(T-i>0?T-i:20),D=D>i?D:i,P.css("height",D)},error:function(e){console.log(e)}}),layer.msg("已成功创建目录",{time:1500},function(){O.push(v),v===-1&&e()})}else layer.msg(t.message,{time:2e3})},error:function(e){console.log(e)}})}break;case"removepage":var k=j.data("page"),x=j.data("project"),N=j.data("parent"),I=window.location.protocol+"//"+window.location.host+"/ShowDoc/page/deletePageById/"+k+"/"+x;$.ajax({url:I,type:"POST",dataType:"json",success:function(t){P.trigger("click"),j.fadeOut(1),t.result&&(N===-1?e():(O.push(v),f.find(".active").remove())),layer.msg(t.message,{timeout:2e3})},error:function(e){console.log(e)}});break;case"removecancel":P.trigger("click");break;case"sharecancel":P.trigger("click");break;case"memberadd":if(!A){A=!0;var C=P.find(".member-manage-container"),G=C.find(".create-member-form"),_=G.find("#_username"),q=_.val(),B=window.location.protocol+"//"+window.location.host+"/ShowDoc/project/addProjectAuthor/"+n;$.ajax({url:B,type:"POST",data:{vname:q},success:function(e){var t=e.trim();if(_.val(""),"success"===t){var o=window.location.protocol+"//"+window.location.host+"/ShowDoc/project/queryProjectAuthor/"+n;$.ajax({url:o,type:"GET",dataType:"json",success:function(e){for(var t="",o=e.length,a=0;a<o;a++)t+='<li class="member-item"><a href="javascript:void(0);" class="btn btn-member" data-event="removemember" data-user="'+e[a].pid+'">'+e[a].vname+"</a></li>";P.find(".member-manage-container").find(".member-list").eq(0).html(t)},error:function(e){console.log(e)}}),layer.msg("已成功添加项目协作者并保存",{timeout:3e3},function(){A=!1})}else"fail"===t?layer.msg("对不起！添加失败啦<br/>可能的原因：项目不存在或您没有添加协作者的权限",{timeout:3e3},function(){A=!1}):"illegal"===t?layer.msg("请输入协作者的用户名",{timeout:3e3},function(){A=!1}):layer.msg("该用户名不存在或者已经添加过该用户啦",{tiemout:3e3},function(){A=!1})},error:function(e){console.log(e)}})}break;case"memberback":P.trigger("click");break;case"removemember":if(!L){L=!0;var M=o.text(),U=o.data("user"),R=window.location.protocol+"//"+window.location.host+"/ShowDoc/project/deleteProjectAuthor/"+U;$.ajax({url:R,type:"POST",data:{vname:M},success:function(e){var t=e.trim();if("success"===t){var o=window.location.protocol+"//"+window.location.host+"/ShowDoc/project/queryProjectAuthor/"+n;$.ajax({url:o,type:"GET",dataType:"json",success:function(e){for(var t="",o=e.length,a=0;a<o;a++)t+='<li class="member-item"><a href="javascript:void(0);" class="btn btn-member" data-event="removemember" data-user="'+e[a].pid+'">'+e[a].vname+"</a></li>";P.find(".member-manage-container").find(".member-list").eq(0).html(t)},error:function(e){console.log(e)}}),layer.msg("已成功删除项目协作者",{timeout:3e3},function(){L=!1})}else"fail"===t?layer.msg("对不起！删除失败啦<br/>可能的原因：项目不存在或您没有删除协作者的权限",{timeout:3e3},function(){L=!1}):layer.msg("该用户名不存在或者已经删除过该用户啦",{tiemout:3e3},function(){L=!1})},error:function(e){console.log(e)}})}break;case"editdir":var z=P.find(".create-dir-container"),F=o.data("parent");z.length<1&&(z=P.find(".edit-dir-container")),z.fadeOut(function(){P.load("./tpls/edit-dir.html",function(e,t,o){var a=P.find(".edit-dir-container"),i=window.location.protocol+"//"+window.location.host+"/ShowDoc/subProject/querySubProjectByID/"+n+"/"+F,r=window.location.protocol+"//"+window.location.host+"/ShowDoc/subProject/getAllProject/"+n,c=a.find(".edit-dir-form"),s=c.find(".form-item").find("#_dirname"),d=c.find(".form-item").find("#_dirnum"),l=c.find(".form-item").find("#_dirparname");a.attr("data-dirid",F),$.ajax({url:i,type:"GET",dataType:"json",success:function(e){s.val(e.subprojectname),d.val(e.subsortid);var t=e;a.attr("data-dirparent",t.parentid),$.ajax({url:r,type:"GET",dataType:"json",success:function(e){for(var o=a.find(".exited-dir").find(".dir-list"),n="",i="",r=a.height(),c=0,s=e.length;c<s;c++)t.parentid===e[c].subProjectId?n+='<option value="'+e[c].subProjectName+'" data-level="'+e[c].nextLevel+'" data-parent="'+e[c].subProjectId+'" selected="selected">'+e[c].subProjectName+"</option>":e[c].subProjectId!==F&&(n+='<option value="'+e[c].subProjectName+'" data-level="'+e[c].nextLevel+'" data-parent="'+e[c].subProjectId+'">'+e[c].subProjectName+"</option>"),"无"!==e[c].subProjectName&&(i+='<li class="dir-item"><a href="javascript:void(0);" class="item-name btn" data-event="editdir" data-parent="'+e[c].subProjectId+'">'+e[c].subProjectName+"</a></li>");l.html(n),o.html(i),r=a.height()+(T-r>0?T-r:20),D=D>r?D:r,P.css("height",D)},error:function(e){console.log(e)}})},error:function(e){console.log(e)}})})});break;case"updatedir":if(!H){H=!0;var J=P.find(".edit-dir-container"),K=J.find(".edit-dir-form"),d=K.find(".form-item").find("#_dirname"),l=K.find(".form-item").find("#_dirnum"),p=K.find(".form-item").find("#_dirparname"),Q=p.find("option:selected"),V=d.val(),W=parseInt(l.val()),X=Q.val(),Y=Q.data("parent"),Z=Q.data("level"),ee=J.data("dirid"),te=J.data("dirparent"),oe=window.location.protocol+"//"+window.location.host+"/ShowDoc/subProject/updateSubProject",y={},ae=window.location.protocol+"//"+window.location.host+"/ShowDoc/subProject/getAllProject/"+n;y={subprojectid:ee,projectid:n,subprojectname:V,sublevel:Z,parentid:Y,parentName:X},isNaN(W)||(y.subsortid=W),d.val(""),l.val(""),$.ajax({url:oe,type:"POST",data:y,dataType:"json",success:function(t){t.result?(a(ae),layer.msg("目录信息已更新并保存",{tiemout:1500},function(){H=!1,Y===-1||te===-1?e():Y!==-1&&te!==-1?(O.push(Y),O.push(te)):Y===-1&&te!==-1?(e(),O.push(te)):Y!==-1&&te===-1&&(e(),O.push(Y))})):layer.msg(t.message,{timeout:2e3},function(){H=!1})},error:function(e){console.log(e)}})}break;case"deletedir":console.log("删除目录");window.location.protocol+"//"+window.location.host+"/ShowDoc/deleteSubProject/{projectid}/{subprojectid}/{parentid}"}t.preventDefault(),t.stopPropagation()}),f.on("click",function(e){var t=$(e.target),a=t.data("type"),i=t.find(".triangle").eq(0);switch(a){case"dir":var r=t.data("parent"),c=t.siblings(".project-list");if(c.length>0&&c.is(":visible")||i.hasClass("top"))return c.slideUp(300),void i.toggleClass("left").css("transition","all 0.3s linear").toggleClass("top").css("transition","");if(c.length>0&&O.indexOf(r)===-1)c.hide().slideDown(300),i.toggleClass("left").css("transition","all 0.3s linear").toggleClass("top").css("transition","");else{var s=O.indexOf(r);s!==-1&&O.splice(s,1),c.remove(),$.ajax({url:_+n+"/"+r,type:"GET",dataType:"json",success:function(e){var o=e.length,a=$("<ul>"),c="";if(a.addClass("project-list"),o>0)for(var s=0;s<o;s++)c+='<li class="dir-item" data-tooltip="目录：'+e[s].subprojectname+'"><a href="javascript:void(0);" class="btn btn-dir" data-type="dir" data-parent="'+e[s].subprojectid+'"><span class="triangle left"></span>'+e[s].subprojectname+"</a></li>";$.ajax({url:q+r+"/"+n,type:"GET",dataType:"json",success:function(e){for(var o=e.length,n=0;n<o;n++)c+='<li class="page-item" data-tooltip="page：'+e[n].pagetitle+'"><a href="javascript:void(0);" class="btn btn-page" data-type="page" data-page="'+e[n].pageid+'" data-parent="'+r+'">'+e[n].pagetitle+"</a></li>";a.html(c).hide(),t.after(a),a.slideDown(300),i.toggleClass("left").css("transition","all 0.3s linear").toggleClass("top").css("transition","")},error:function(e){console.log(e)}})},error:function(e){console.log(e)}})}break;case"page":var d=t.data("page"),l=(t.data("parent"),window.location.protocol+"//"+window.location.host+"/ShowDoc/page/selectPageById/"+d+"/"+n);B=d,t.hasClass("active")||($(this).find(".btn-page").removeClass("active"),t.removeClass("hover").addClass("active"),o(l))}e.preventDefault(),e.stopPropagation()}),f.on("mouseover",function(e){var t=$(e.target),o=t.data("type");"page"!==o||t.hasClass("hover")||t.hasClass("active")||t.addClass("hover"),t.parent().addClass("hover")}).on("mouseout",function(e){var t=$(e.target),o=t.data("type");"page"===o&&t.hasClass("hover")&&t.removeClass("hover"),t.parent().removeClass("hover")}),m.on("click",function(e){var o=$(e.target),a=o.data("role");switch(a){case"share":t();break;case"copy":var i=window.location.protocol+"//"+window.location.host+"/ShowDoc/jsp/project/editproject.jsp?projectid="+n+"&projectname="+C+"&check="+E+"&pageid="+B+"&type=copy";window.location.href=i;break;case"edit":var i=window.location.protocol+"//"+window.location.host+"/ShowDoc/jsp/project/editproject.jsp?projectid="+n+"&projectname="+C+"&check="+E+"&pageid="+B+"&type=edit";window.location.href=i;break;case"remove":x=$(document).height(),D=T>x?T:x,P.css("height",D).fadeIn(200),P.load("./tpls/remove-page.html",function(e,t,o){var a=P.find(".remove-page-container"),n=a.height(),i=(T-n)/2;i=i>0?i:20,a.css("top",-n).animate({opacity:"1",top:i},200,function(){a.animate({top:i-30},200,function(){a.animate({top:i},200)})})})}e.preventDefault(),e.stopPropagation()}),d.hover(function(e){k||(l.addClass("hover"),p.fadeIn(100).css("top","25px").animate({top:"35px"},300,function(){k=!1})),e.preventDefault(),e.stopPropagation()},function(e){l.removeClass("hover"),p.fadeOut(200),e.preventDefault(),e.stopPropagation()}),d.on("click",function(e){var o=$(e.target),a=o.data("item");switch(a){case"share":t();break;case"member":x=$(document).height(),D=T>x?T:x,P.css("height",D).fadeIn(200),P.load("./tpls/member-manage.html",function(e,t,o){var a=P.find(".member-manage-container"),i=a.find(".member-list").eq(0),r=a.height(),c=(T-r)/2,s=window.location.protocol+"//"+window.location.host+"/ShowDoc/project/queryProjectAuthor/"+n;c=c>0?c:20,$.ajax({url:s,type:"GET",dataType:"json",success:function(e){for(var t="",o=e.length,n=0;n<o;n++)t+='<li class="member-item"><a href="javascript:void(0);" class="btn btn-member" data-event="removemember" data-user="'+e[n].pid+'">'+e[n].vname+"</a></li>";i.html(t),r=a.height(),c=(T-r)/2,c=c>0?c:20,a.css("top",-r).animate({opacity:"1",top:c},200,function(){a.animate({top:c-30},200,function(){a.animate({top:c},200)})})},error:function(e){console.log(e)}})});break;case"delete":var i=window.location.protocol+"//"+window.location.host+"/ShowDoc/project/deleteProject/"+n;$.ajax({url:i,type:"POST",dataType:"json",success:function(e){e.result?layer.msg("已成功删除项目",{timeout:3e3},function(){}):layer.msg(e.message,{timeout:3e3},function(){})},error:function(e){console.log(e)}});break;case"project":window.location.href=window.location.protocol+"//"+window.location.host+"/ShowDoc/project/showProject.action"}e.preventDefault(),e.stopPropagation()})});