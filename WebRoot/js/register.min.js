$(function(){var e=$("#register-username"),r=$("#register-form"),i=r.find(".border-item"),o=$("#register-picture"),s=r.find(".item-upimg-name");$registerSubmit=r.find("#form-submit"),isUsername=!1,isFirstValidation=!0,$password=$("#register-password"),$passwordAgain=$("#register-checkpwd"),$email=$("#register-email"),$tmpImg=$("<img />"),$vCode=r.find("#register-checkImg"),$checkImg=r.find("#show-checkImg"),$checkImgIcon=r.find(".checkImg-icon"),$checkImgInfo=r.find(".checkImg-error-info"),srcUrl=window.location.protocol+"//"+window.location.host+"/ShowDoc/voucher/getCaptchar.action?temp="+(new Date).getTime().toString(36),codeUrl=window.location.protocol+"//"+window.location.host+"/ShowDoc/voucher/getVcode.action",isCoded=!1,$registerSubmit.attr("disabled","disabled").css("cursor","not-allowed"),$(".SlectBox").SumoSelect({csvDispCount:12,forceCustomRendering:!0,search:!0}),$tmpImg.on("load",function(){$checkImg.attr("src",srcUrl)}),$tmpImg.attr("src",srcUrl),$checkImg.on("click",function(){srcUrl=window.location.protocol+"//"+window.location.host+"/ShowDoc/voucher/getCaptchar.action?temp="+(new Date).getTime().toString(36),$tmpImg.on("load",function(){$checkImg.attr("src",srcUrl),$checkImgIcon.html(""),$vCode.val("").focus(),$checkImgInfo.hide(),$registerSubmit.attr("disabled","disabled").css("cursor","not-allowed"),isCoded=!1}),$tmpImg.attr("src",srcUrl)}),i.on("click",function(){i.removeClass("border-active-item").addClass("border-item"),$(this).removeClass("border-item").addClass("border-active-item")}),o.on("change",function(){var e=this.files[0];if(s.html(e.name),r.validate().element(this),!r.validate().element(this))return void o.blur();var i=new FileReader;i.readAsDataURL(e),i.onload=function(e){$(".item-img-result").attr("src",this.result).show(),$(".item-show-title").hide()}}),$vCode.on("blur",function(){if(!isCoded||!$vCode.val()||4!=$vCode.val().length){var e=$vCode.val();$.ajax({url:codeUrl,type:"GET",dataType:"text",async:!1,success:function(r){var i=r.trim();e===i?($checkImgIcon.css("color","#87F880").html("&#xe900;").show(),$checkImgInfo.hide(),$registerSubmit.removeAttr("disabled").css("cursor","pointer"),isCoded=!0):($checkImgIcon.css("color","#F9998E").html("&#xe901;").show(),$checkImgInfo.show(),$registerSubmit.attr("disabled","disabled").css("cursor","not-allowed"),isCoded=!1)}})}}).on("keyup",function(){if(isCoded=!1,$(this).val()&&$(this).val().length>=4&&!isCoded){var e=$vCode.val();$.ajax({url:codeUrl,type:"GET",dataType:"text",async:!1,success:function(r){var i=r.trim();e===i?($checkImgIcon.css("color","#87F880").html("&#xe900;").show(),$checkImgInfo.hide(),$registerSubmit.removeAttr("disabled").css("cursor","pointer"),isCoded=!0):($checkImgIcon.css("color","#F9998E").html("&#xe901;").show(),$checkImgInfo.show(),$registerSubmit.attr("disabled","disabled").css("cursor","not-allowed"),isCoded=!1)}})}}),$.validator.addMethod("isImage",function(e,r){return this.optional(r)||/\w*.jpg|\w*.png|\w*.gif/.test(e)},"只能上传图片"),$.validator.addMethod("isToLarge",function(e,r){var i=r.files[0];return this.optional(r)||i.size/1024<3072},"文件大小不能超过3M"),$("#register-form").validate({rules:{"voucher.username":{required:!0,rangelength:[6,15]},"voucher.password":{required:!0,rangelength:[6,40]},passwordAgain:{required:!0,rangelength:[6,40],equalTo:"#register-password"},"voucherInfo.email":{required:!0,email:!0},pictures:{isImage:!0,isToLarge:!0}},messages:{"voucher.username":{required:"未输入用户名",rangelength:"用户名为6-15位"},"voucher.password":{required:"未输入密码",rangelength:"密码长度为6-40位"},passwordAgain:{required:"未输入确认密码",rangelength:"密码长度为6-40位",equalTo:"两次密码输入不一致"},"voucherInfo.email":{required:"未输入邮箱",email:"无效的电子邮件地址"},pictures:{isImage:"只能上传图片",isToLarge:"文件大小不能超过3M"}},onfocusout:!1,onkeyup:!1,errorClass:"valid-error",validClass:"valid-pass",errorElement:"i",errorContainer:!0}),function(){$("#register-form").validate().element(e),$("#register-username-error").css("opacity","0")}(),$("#form-submit").on("click",function(e){return isFirstValidation=!1,$("#register-username-error").css("opacity","1"),$("#register-form").valid()&&isUsername&&$("#register-form").submit(),!1}),e.on("blur",function(){$("#register-username-error").css("opacity","1");var r=$(this).val(),i="/ShowDoc/voucher/queryByName.action?username="+r;$("#register-form").validate().element(this)&&$.ajax({type:"POST",url:i,dataType:"text",success:function(r){var i=r.trim();if("success"===i)isUsername=!0;else if("fail"===i)isUsername=!1,e.removeClass("valid-pass").addClass("valid-error").siblings("i").text("用户名已经被注册.").css("display","inline");else if("illegal"===i)e.removeClass("valid-pass").addClass("valid-error").siblings("i").text("用户名应该为6~15位.").css("display","inline");else{var o=r.replace(/\s/,""),s=o.indexOf('<h3 class="error-info">')+'<h3 class="error-info">'.length,t=o.lastIndexOf("</h3>"),a=o.substring(s,t),n=window.location.protocol+"//"+window.location.host+"/ShowDoc/",c=n+"exception/operateVoucherHandle.action?message="+a;window.location.href=c}}})}),$password.on("blur",function(){isFirstValidation||$("#register-form").validate().element(this)}),$passwordAgain.on("blur",function(){isFirstValidation||$("#register-form").validate().element(this)}),$email.on("blur",function(){isFirstValidation||$("#register-form").validate().element(this)})});